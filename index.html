<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>VR + Mobile + Desktop Controls</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <!-- Oculus Thumbstick Controls -->
    <script src="https://cdn.jsdelivr.net/gh/gftruj/aframe-oculus-thumbstick-controls@master/oculus-thumbstick-controls.js"></script>

    <!-- Super Hands -->
    <script src="https://cdn.jsdelivr.net/npm/super-hands@4.0.5/dist/super-hands.min.js"></script>

    <!-- NippleJS -->
    <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        touch-action: none;
      }

      #joystick-left, #joystick-right {
        position: absolute;
        bottom: 40px;
        width: 120px;
        height: 120px;
        z-index: 999;
        display: none;
      }

      #joystick-left {
        left: 40px;
      }

      #joystick-right {
        right: 40px;
      }
    </style>
  </head>

  <body>
    <!-- Touchscreen joysticks -->
    <div id="joystick-left"></div>
    <div id="joystick-right"></div>

    <a-scene vr-mode-ui="enabled: true" embedded>
      <!-- Rig principal com componente customizado -->
      <a-entity id="rig" movement-handler oculus-thumbstick-controls position="0 1.6 0">
        <a-camera wasd-controls look-controls></a-camera>
      </a-entity>

      <!-- Controladores VR -->
      <a-entity laser-controls="hand: left; model: true"
                raycaster="objects: .interactable"
                super-hands></a-entity>

      <a-entity laser-controls="hand: right; model: true"
                raycaster="objects: .interactable"
                super-hands></a-entity>

      <!-- Objetos interativos -->
      <a-box class="interactable" position="0 1 -3" color="tomato"
             grabbable stretchable draggable drag-rotate></a-box>

      <a-sphere class="interactable" position="2 1 -3" radius="0.5" color="skyblue"
                grabbable stretchable draggable drag-rotate></a-sphere>

      <!-- Ambiente -->
      <a-plane rotation="-90 0 0" width="30" height="30" color="#7BC8A4"></a-plane>
      <a-sky color="#ECECEC"></a-sky>
    </a-scene>

    <script>
      const joystickLeft = document.getElementById('joystick-left');
      const joystickRight = document.getElementById('joystick-right');

      let moveX = 0, moveY = 0, rotY = 0;
      let isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

      function toggleTouchUI(show) {
        joystickLeft.style.display = show ? 'block' : 'none';
        joystickRight.style.display = show ? 'block' : 'none';
      }

      AFRAME.scenes[0].addEventListener('enter-vr', () => toggleTouchUI(false));
      AFRAME.scenes[0].addEventListener('exit-vr', () => toggleTouchUI(isMobile));

      // NippleJS - Joystick esquerdo (movimento)
      nipplejs.create({
        zone: joystickLeft,
        mode: 'static',
        position: { left: '50%', top: '50%' },
        color: 'blue'
      }).on('move', (evt, data) => {
        const angle = data.angle.radian;
        const force = data.force;
        moveX = Math.cos(angle) * force * 0.05;
        moveY = Math.sin(angle) * force * 0.05;
      }).on('end', () => {
        moveX = 0;
        moveY = 0;
      });

      // NippleJS - Joystick direito (rotação)
      nipplejs.create({
        zone: joystickRight,
        mode: 'static',
        position: { left: '50%', top: '50%' },
        color: 'red'
      }).on('move', (evt, data) => {
        rotY = data.vector.x * 5;
      }).on('end', () => {
        rotY = 0;
      });

      // Componente para movimentação no mobile
      AFRAME.registerComponent('movement-handler', {
        tick: function () {
          const rig = this.el;
          const pos = rig.getAttribute('position');
          const rot = rig.getAttribute('rotation');

          const angle = THREE.Math.degToRad(rot.y);
          pos.x += Math.sin(angle) * moveY + Math.cos(angle) * moveX;
          pos.z += Math.cos(angle) * moveY - Math.sin(angle) * moveX;
          rig.setAttribute('position', pos);

          rot.y += rotY * 0.5;
          rig.setAttribute('rotation', rot);
        }
      });

      window.addEventListener('DOMContentLoaded', () => {
        toggleTouchUI(isMobile);
      });
    </script>
  </body>
</html>
