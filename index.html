<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>VR Interação com Objetos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/super-hands@4.0.5/dist/super-hands.min.js"></script>
  </head>

  <body style="margin: 0; overflow: hidden; touch-action: none;">
    <div id="joystick-left" style="position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; z-index: 10; display: none;"></div>
    <div id="joystick-right" style="position: absolute; bottom: 40px; right: 40px; width: 120px; height: 120px; z-index: 10; display: none;"></div>

    <a-scene vr-mode-ui="enabled: true" renderer="antialias: true">
      <!-- RIG -->
      <a-entity id="cameraRig" position="0 1.6 0" movement-handler>
        <a-camera id="playerCam" wasd-controls="enabled: false" look-controls="enabled: true"></a-camera>

        <!-- Mãos com laser pointer e super-hands -->
        <a-entity id="leftHand"
                  laser-controls="hand: left"
                  raycaster="objects: .interactable"
                  super-hands></a-entity>

        <a-entity id="rightHand"
                  laser-controls="hand: right"
                  raycaster="objects: .interactable"
                  super-hands></a-entity>
      </a-entity>

      <!-- Objetos interativos -->
      <a-box class="interactable" position="0 1 -3" color="tomato" 
             dynamic-body
             hoverable grabbable stretchable draggable drag-rotate></a-box>

      <a-sphere class="interactable" position="2 1 -3" radius="0.5" color="skyblue"
                hoverable grabbable stretchable draggable drag-rotate></a-sphere>

      <a-plane rotation="-90 0 0" width="30" height="30" color="#7BC8A4"></a-plane>
      <a-sky color="#ECECEC"></a-sky>
    </a-scene>

    <script>
      window.addEventListener('DOMContentLoaded', () => {
        const cameraRig = document.getElementById('cameraRig');
        const joystickLeft = document.getElementById('joystick-left');
        const joystickRight = document.getElementById('joystick-right');

        let moveX = 0, moveY = 0, rotY = 0;
        let isVR = false;

        function isTouchDevice() {
          return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        }

        function checkMode() {
          isVR = AFRAME.scenes[0].is('vr-mode');
          joystickLeft.style.display = isVR ? 'none' : isTouchDevice() ? 'block' : 'none';
          joystickRight.style.display = isVR ? 'none' : isTouchDevice() ? 'block' : 'none';
        }

        AFRAME.scenes[0].addEventListener('enter-vr', checkMode);
        AFRAME.scenes[0].addEventListener('exit-vr', checkMode);

        // Joysticks mobile
        nipplejs.create({
          zone: joystickLeft,
          mode: 'static',
          position: { left: '50%', top: '50%' },
          color: 'blue'
        }).on('move', (evt, data) => {
          const angle = data.angle.radian;
          const force = data.force;
          moveX = Math.cos(angle) * force * 0.05;
          moveY = Math.sin(angle) * force * 0.05;
        }).on('end', () => {
          moveX = 0;
          moveY = 0;
        });

        nipplejs.create({
          zone: joystickRight,
          mode: 'static',
          position: { left: '50%', top: '50%' },
          color: 'red'
        }).on('move', (evt, data) => {
          rotY = data.vector.x * 5;
        }).on('end', () => {
          rotY = 0;
        });

        // Movimento VR e Touch
        AFRAME.registerComponent('movement-handler', {
          init: function () {
            const leftHand = document.getElementById('leftHand');
            const rightHand = document.getElementById('rightHand');

            leftHand.addEventListener('thumbstickmoved', (evt) => {
              moveX = evt.detail.x * 0.05;
              moveY = -evt.detail.y * 0.05;
            });
            leftHand.addEventListener('thumbsticktouchend', () => {
              moveX = 0;
              moveY = 0;
            });

            rightHand.addEventListener('thumbstickmoved', (evt) => {
              rotY = evt.detail.x * 3;
            });
            rightHand.addEventListener('thumbsticktouchend', () => {
              rotY = 0;
            });
          },

          tick: function () {
            const pos = cameraRig.getAttribute('position');
            const rot = cameraRig.getAttribute('rotation');
            const angleRad = THREE.MathUtils.degToRad(rot.y);

            pos.x += Math.sin(angleRad) * moveY + Math.cos(angleRad) * moveX;
            pos.z += Math.cos(angleRad) * moveY - Math.sin(angleRad) * moveX;
            cameraRig.setAttribute('position', pos);

            rot.y += rotY * 0.05;
            cameraRig.setAttribute('rotation', rot);
          }
        });

        checkMode();
      });
    </script>
  </body>
</html>
